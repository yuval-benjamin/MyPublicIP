IMAGE_NAME = 'my-app'
IMAGE_TAG = '1.0.0'
REGISTRY_URL = 'yuvalbenjamin'
MAIN_BRANCH = 'main'

node {
    withCredentials([kubernetesSecret(credentialsId: 'docker-credentials', secretKey: '.dockercfg', variable: 'DOCKER_CFG')]) {
 
        def branch = env.BRANCH_NAME

        stage('Checkout') {
            checkout scm
        }

        stage('Run Tests & Build Docker Image') { 

            // If on main branch, push Docker image
            if (branch == MAIN_BRANCH) {
                final_image_name = "${REGISTRY_URL}/${IMAGE_NAME}:${IMAGE_TAG}"
                sh """
                    echo ${DOCKER_CFG} > ~/.docker/config.json
                    docker build -t ${final_image_name} ./
                    docker push ${final_image_name}
                    docker tag ${final_image_name} ${REGISTRY_URL}/${IMAGE_NAME}:latest
                    docker push ${REGISTRY_URL}/${IMAGE_NAME}:latest
                """
            } else {
                sh 'docker build --target tester -t ${IMAGE_NAME}-test ./'
            }
        }

    }
}